<!DOCTYPE html>
<html>
<head>
  <title>Student Registration</title>
</head>
<body>

<h2>New Student Registration</h2>

<p><b>School:</b> <span id="schoolName">Loading...</span></p>
<p><b>Registration Fee:</b> â‚¹<span id="feeAmount">0</span></p>

<hr>

<h3>Student Details</h3>
<input type="text" id="name" placeholder="Full Name"><br><br>
<input type="email" id="email" placeholder="Email"><br><br>
<input type="password" id="password" placeholder="Password"><br><br>

<hr>

<h3>Pay via UPI</h3>
<p><b>UPI ID:</b> <span id="upiId">Loading...</span></p>
<img id="qr" width="200"><br><br>

<input type="text" id="utr" placeholder="Enter UTR / Transaction ID"><br><br>

<button onclick="register()">Submit Registration</button>

<p id="msg"></p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAw6mNbrIILP9fNNSzAXuPEUsN7x3T0dsY",
  authDomain: "schoolerp-cb790.firebaseapp.com",
  projectId: "schoolerp-cb790",
  storageBucket: "schoolerp-cb790.firebasestorage.app",
  messagingSenderId: "1098794553484",
  appId: "1:1098794553484:web:b8d2abe9b829f8fa7d2ba9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Load payment settings
const payRef = doc(db, "schools", "school1", "settings", "payment");
const snap = await getDoc(payRef);

const pay = snap.data();
document.getElementById("schoolName").innerText = pay.school;
document.getElementById("feeAmount").innerText = pay.amount;
document.getElementById("upiId").innerText = pay.upiId;

// Generate QR
const qrData = `upi://pay?pa=${pay.upiId}&pn=${pay.school}&am=${pay.amount}`;
document.getElementById("qr").src =
  "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
  encodeURIComponent(qrData);

// Register function
window.register = async function () {
  const name = name.value;
  const email = email.value;
  const password = password.value;
  const utr = utr.value;

  if (!name || !email || !password || !utr) {
    alert("All fields required");
    return;
  }

  const user = await createUserWithEmailAndPassword(auth, email, password);

  await setDoc(doc(db, "schools", "school1", "students_pending", user.user.uid), {
    name,
    email,
    utr,
    fee: pay.amount,
    status: "pending",
    createdAt: Date.now()
  });

  document.getElementById("msg").innerText =
    "Registration submitted. Admin approval pending.";
};
</script>

</body>
</html>
